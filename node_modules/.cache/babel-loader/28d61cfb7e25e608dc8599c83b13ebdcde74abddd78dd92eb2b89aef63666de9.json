{"ast":null,"code":"const KEY_STORAGE = 'gemini_api_key';\nexport const setGeminiKey = k => {\n  localStorage.setItem(KEY_STORAGE, (k || '').trim());\n};\nexport const getGeminiKey = () => {\n  return localStorage.getItem(KEY_STORAGE) || '';\n};\nexport async function generateQuestionsWithGemini(prompt, count = 10) {\n  var _data$candidates, _data$candidates$, _data$candidates$$con, _data$candidates$$con2, _data$candidates$$con3;\n  const apiKey = getGeminiKey();\n  if (!apiKey) throw new Error('Gemini API 키가 없습니다.');\n  const model = 'gemini-1.5-flash';\n\n  // 2022 교육과정 준수 + 모호어(소수) 해석 규칙 + 개수 강제\n  const sys = `역할: 당신은 대한민국 \"2022 개정 교육과정\" 기반의 학습용 문제 제작자입니다.\n규칙:\n- 반드시 \"2022 개정 교육과정\"의 성취기준/학년 적합성을 준수해 출제하세요.\n- 사용자의 요청(학년/주제/형식/개수)을 해석해 적절한 난이도와 표현으로 한국어 문제를 만듭니다.\n- \"소수\"가 초등 맥락이면 기본적으로 \"소수(Decimal, 소수점)\"로 해석하세요. \"소수(Prime)\"가 필요하면 요청에 '소수(소수: prime)'처럼 분명히 명시되어야 합니다.\n- 출력은 아래 JSON 배열만 허용(설명/코드블록/추가 문장 금지).\n- 각 항목은 { \"type\":\"ox|multiple|short\", \"question\":\"...\", \"options\":[...], \"correctAnswer\":\"...|index\", \"score\":10 } 형태.\n  * multiple은 options 필수, correctAnswer는 0부터 시작하는 정답 index\n  * ox는 options 없이 correctAnswer는 \"O\" 또는 \"X\"\n  * short는 correctAnswer는 문자열 정답\n- 문자열 내 개행/따옴표는 이스케이프 처리\n- 반드시 length=${count} 정확히 맞추세요.`;\n  const user = `사용자 요청: ${prompt}\\n원하는 개수: ${count}\\n출력 형식: 위 JSON 배열만 반환`;\n  const responseSchema = {\n    type: 'ARRAY',\n    items: {\n      type: 'OBJECT',\n      properties: {\n        id: {\n          type: 'STRING'\n        },\n        type: {\n          type: 'STRING'\n        },\n        question: {\n          type: 'STRING'\n        },\n        options: {\n          type: 'ARRAY',\n          items: {\n            type: 'STRING'\n          }\n        },\n        correctAnswer: {\n          type: 'STRING'\n        },\n        score: {\n          type: 'NUMBER'\n        }\n      },\n      required: ['type', 'question', 'correctAnswer']\n    }\n  };\n  const body = {\n    contents: [{\n      role: 'user',\n      parts: [{\n        text: sys\n      }]\n    }, {\n      role: 'user',\n      parts: [{\n        text: user\n      }]\n    }],\n    generationConfig: {\n      responseMimeType: 'application/json',\n      responseSchema\n    }\n  };\n  const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}`, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json'\n    },\n    body: JSON.stringify(body)\n  });\n  if (!res.ok) throw new Error('Gemini 호출 실패');\n  const data = await res.json();\n  let text = (data === null || data === void 0 ? void 0 : (_data$candidates = data.candidates) === null || _data$candidates === void 0 ? void 0 : (_data$candidates$ = _data$candidates[0]) === null || _data$candidates$ === void 0 ? void 0 : (_data$candidates$$con = _data$candidates$.content) === null || _data$candidates$$con === void 0 ? void 0 : (_data$candidates$$con2 = _data$candidates$$con.parts) === null || _data$candidates$$con2 === void 0 ? void 0 : (_data$candidates$$con3 = _data$candidates$$con2[0]) === null || _data$candidates$$con3 === void 0 ? void 0 : _data$candidates$$con3.text) || '';\n  // code fence 제거\n  if (text.startsWith('```')) {\n    const first = text.indexOf('\\n');\n    const lastFence = text.lastIndexOf('```');\n    if (first !== -1 && lastFence !== -1) text = text.slice(first + 1, lastFence);\n  }\n  let parsed;\n  try {\n    parsed = JSON.parse(text);\n  } catch {\n    const jsonStart = text.indexOf('[');\n    const jsonEnd = text.lastIndexOf(']');\n    if (jsonStart === -1 || jsonEnd === -1) throw new Error('AI 응답 파싱 실패');\n    parsed = JSON.parse(text.slice(jsonStart, jsonEnd + 1));\n  }\n  const arr = Array.isArray(parsed) ? parsed : [parsed];\n  const isValidItem = q => q && ['ox', 'multiple', 'short'].includes(q.type) && typeof q.question === 'string' && (q.type !== 'multiple' || Array.isArray(q.options));\n  let items = arr.filter(isValidItem);\n  if (items.length > count) items = items.slice(0, count);\n  if (items.length < count) {\n    throw new Error(`AI가 ${items.length}개만 반환했습니다. 프롬프트를 조금 더 구체적으로 입력하거나 다시 시도하세요.`);\n  }\n  return items.map((q, i) => ({\n    id: q.id || `ai_${Date.now()}_${i}`,\n    type: q.type,\n    question: q.question,\n    options: q.options,\n    correctAnswer: q.correctAnswer,\n    score: typeof q.score === 'number' ? q.score : 10\n  }));\n}","map":{"version":3,"names":["KEY_STORAGE","setGeminiKey","k","localStorage","setItem","trim","getGeminiKey","getItem","generateQuestionsWithGemini","prompt","count","_data$candidates","_data$candidates$","_data$candidates$$con","_data$candidates$$con2","_data$candidates$$con3","apiKey","Error","model","sys","user","responseSchema","type","items","properties","id","question","options","correctAnswer","score","required","body","contents","role","parts","text","generationConfig","responseMimeType","res","fetch","encodeURIComponent","method","headers","JSON","stringify","ok","data","json","candidates","content","startsWith","first","indexOf","lastFence","lastIndexOf","slice","parsed","parse","jsonStart","jsonEnd","arr","Array","isArray","isValidItem","q","includes","filter","length","map","i","Date","now"],"sources":["C:/Users/9204r/.cursor/avatar/src/services/ai.ts"],"sourcesContent":["export type AiQuestion = {\r\n  id?: string;\r\n  type: 'ox' | 'multiple' | 'short';\r\n  question: string;\r\n  options?: string[];\r\n  correctAnswer: string | number;\r\n  score?: number;\r\n};\r\n\r\nconst KEY_STORAGE = 'gemini_api_key';\r\n\r\nexport const setGeminiKey = (k: string) => {\r\n  localStorage.setItem(KEY_STORAGE, (k || '').trim());\r\n};\r\n\r\nexport const getGeminiKey = (): string => {\r\n  return localStorage.getItem(KEY_STORAGE) || '';\r\n};\r\n\r\nexport async function generateQuestionsWithGemini(prompt: string, count = 10): Promise<AiQuestion[]> {\r\n  const apiKey = getGeminiKey();\r\n  if (!apiKey) throw new Error('Gemini API 키가 없습니다.');\r\n\r\n  const model = 'gemini-1.5-flash';\r\n\r\n  // 2022 교육과정 준수 + 모호어(소수) 해석 규칙 + 개수 강제\r\n  const sys = `역할: 당신은 대한민국 \"2022 개정 교육과정\" 기반의 학습용 문제 제작자입니다.\r\n규칙:\r\n- 반드시 \"2022 개정 교육과정\"의 성취기준/학년 적합성을 준수해 출제하세요.\r\n- 사용자의 요청(학년/주제/형식/개수)을 해석해 적절한 난이도와 표현으로 한국어 문제를 만듭니다.\r\n- \"소수\"가 초등 맥락이면 기본적으로 \"소수(Decimal, 소수점)\"로 해석하세요. \"소수(Prime)\"가 필요하면 요청에 '소수(소수: prime)'처럼 분명히 명시되어야 합니다.\r\n- 출력은 아래 JSON 배열만 허용(설명/코드블록/추가 문장 금지).\r\n- 각 항목은 { \"type\":\"ox|multiple|short\", \"question\":\"...\", \"options\":[...], \"correctAnswer\":\"...|index\", \"score\":10 } 형태.\r\n  * multiple은 options 필수, correctAnswer는 0부터 시작하는 정답 index\r\n  * ox는 options 없이 correctAnswer는 \"O\" 또는 \"X\"\r\n  * short는 correctAnswer는 문자열 정답\r\n- 문자열 내 개행/따옴표는 이스케이프 처리\r\n- 반드시 length=${count} 정확히 맞추세요.`;\r\n\r\n  const user = `사용자 요청: ${prompt}\\n원하는 개수: ${count}\\n출력 형식: 위 JSON 배열만 반환`;\r\n\r\n  const responseSchema = {\r\n    type: 'ARRAY',\r\n    items: {\r\n      type: 'OBJECT',\r\n      properties: {\r\n        id: { type: 'STRING' },\r\n        type: { type: 'STRING' },\r\n        question: { type: 'STRING' },\r\n        options: { type: 'ARRAY', items: { type: 'STRING' } },\r\n        correctAnswer: { type: 'STRING' },\r\n        score: { type: 'NUMBER' }\r\n      },\r\n      required: ['type', 'question', 'correctAnswer']\r\n    }\r\n  } as any;\r\n\r\n  const body = {\r\n    contents: [\r\n      { role: 'user', parts: [{ text: sys }] },\r\n      { role: 'user', parts: [{ text: user }] }\r\n    ],\r\n    generationConfig: {\r\n      responseMimeType: 'application/json',\r\n      responseSchema\r\n    }\r\n  } as any;\r\n\r\n  const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}` , {\r\n    method: 'POST',\r\n    headers: { 'Content-Type':'application/json' },\r\n    body: JSON.stringify(body),\r\n  });\r\n  if (!res.ok) throw new Error('Gemini 호출 실패');\r\n  const data = await res.json();\r\n\r\n  let text: string = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';\r\n  // code fence 제거\r\n  if (text.startsWith('```')) {\r\n    const first = text.indexOf('\\n');\r\n    const lastFence = text.lastIndexOf('```');\r\n    if (first !== -1 && lastFence !== -1) text = text.slice(first + 1, lastFence);\r\n  }\r\n  let parsed: any;\r\n  try {\r\n    parsed = JSON.parse(text);\r\n  } catch {\r\n    const jsonStart = text.indexOf('[');\r\n    const jsonEnd = text.lastIndexOf(']');\r\n    if (jsonStart === -1 || jsonEnd === -1) throw new Error('AI 응답 파싱 실패');\r\n    parsed = JSON.parse(text.slice(jsonStart, jsonEnd + 1));\r\n  }\r\n  const arr: any[] = Array.isArray(parsed) ? parsed : [parsed];\r\n  const isValidItem = (q: any) => q && ['ox','multiple','short'].includes(q.type) && typeof q.question === 'string' && (q.type !== 'multiple' || Array.isArray(q.options));\r\n  let items = arr.filter(isValidItem);\r\n  if (items.length > count) items = items.slice(0, count);\r\n  if (items.length < count) {\r\n    throw new Error(`AI가 ${items.length}개만 반환했습니다. 프롬프트를 조금 더 구체적으로 입력하거나 다시 시도하세요.`);\r\n  }\r\n\r\n  return items.map((q, i) => ({\r\n    id: q.id || `ai_${Date.now()}_${i}`,\r\n    type: q.type,\r\n    question: q.question,\r\n    options: q.options,\r\n    correctAnswer: q.correctAnswer,\r\n    score: typeof q.score === 'number' ? q.score : 10,\r\n  }));\r\n}\r\n\r\n\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}